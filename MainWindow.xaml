<Window x:Class="WindBoard.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="WindBoard" Height="450" Width="800"
        WindowState="Maximized"
        Loaded="Window_Loaded">

    <Grid x:Name="RootGrid" Background="#2E2F33" ClipToBounds="False">
        <Grid.Resources>
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        </Grid.Resources>

        <!-- 视口：负责“看哪里” -->
        <ScrollViewer x:Name="Viewport"
                      Background="#2E2F33"
                      HorizontalScrollBarVisibility="Hidden"
                      VerticalScrollBarVisibility="Hidden"
                      CanContentScroll="False"
                      PanningMode="None"
                      IsManipulationEnabled="False">

            <!-- 承载层：负责整体缩放（不要缩放 InkCanvas 自己） -->
            <Grid x:Name="CanvasHost" Background="#2E2F33">
                <Grid.LayoutTransform>
                    <ScaleTransform x:Name="ZoomTransform" ScaleX="1" ScaleY="1"/>
                </Grid.LayoutTransform>

                <!-- 核心白板控件：不再使用 RenderTransform -->
                <InkCanvas Name="MyCanvas"
                           Background="#2E2F33"
                           Width="8000" Height="8000"
                           HorizontalAlignment="Left" VerticalAlignment="Top"
                           Margin="0"
                           IsManipulationEnabled="False"
                           TouchDown="MyCanvas_TouchDown"
                           TouchMove="MyCanvas_TouchMove"
                           TouchUp="MyCanvas_TouchUp"
                           TouchLeave="MyCanvas_TouchUp"
                           MouseWheel="MyCanvas_MouseWheel">

                    <InkCanvas.DefaultDrawingAttributes>
                        <DrawingAttributes Color="White" Width="3" Height="3" IgnorePressure="True" FitToCurve="True"/>
                    </InkCanvas.DefaultDrawingAttributes>
                </InkCanvas>

                <!-- 自定义橡皮擦游标覆盖层：跟随内容缩放（不拦截输入） -->
                <Canvas x:Name="EraserOverlay"
                        Width="{Binding ElementName=MyCanvas, Path=Width}"
                        Height="{Binding ElementName=MyCanvas, Path=Height}"
                        IsHitTestVisible="False"
                        Visibility="Collapsed"
                        Panel.ZIndex="5">
                    <Border x:Name="EraserCursorRect"
                            Background="#FFFAFA"
                            CornerRadius="0"
                            Width="40"
                            Height="80"
                            Opacity="1.0"/>
                </Canvas>
            </Grid>
        </ScrollViewer>

        <!-- 悬浮工具栏（覆盖在视口之上，不参与缩放） -->
        <Border VerticalAlignment="Bottom" HorizontalAlignment="Center" Margin="0,0,0,30"
                Background="#25262A" CornerRadius="12" Padding="5"
                Effect="{StaticResource MaterialDesignShadowDepth2}"
                Panel.ZIndex="10">
            <StackPanel Orientation="Horizontal">
                <RadioButton Name="RadioPen" Content="书写" Tag="Pen" GroupName="Tools" IsChecked="True"
                             Style="{StaticResource BottomRadioButtonStyle}"
                             Checked="RadioPen_Checked"
                             PreviewMouseLeftButtonDown="RadioPen_PreviewMouseLeftButtonDown"
                             ToolTip="再次单击设置画笔"/>

                <RadioButton Name="RadioEraser" Content="擦除" Tag="Eraser" GroupName="Tools"
                             Style="{StaticResource BottomRadioButtonStyle}"
                             Checked="RadioEraser_Checked"/>

                <RadioButton Name="RadioSelect" Content="选择" Tag="CursorDefault" GroupName="Tools"
                             Style="{StaticResource BottomRadioButtonStyle}"
                             Checked="RadioSelect_Checked"/>

                <Rectangle Width="1" Height="24" Fill="#505050" Margin="8,0" VerticalAlignment="Center"/>

                <Button Name="BtnUndo" Content="撤销" Tag="Undo"
                        Style="{StaticResource BottomButtonStyle}"
                        Command="{x:Static ApplicationCommands.Undo}"
                        CommandTarget="{Binding ElementName=MyCanvas}"/>

                <Button Name="BtnRedo" Content="恢复" Tag="Redo"
                        Style="{StaticResource BottomButtonStyle}"
                        Command="{x:Static ApplicationCommands.Redo}"
                        CommandTarget="{Binding ElementName=MyCanvas}"/>
            </StackPanel>
        </Border>

        <!-- 右下角：分页控制条（覆盖在视口之上，不参与缩放） -->
        <Border VerticalAlignment="Bottom"
                HorizontalAlignment="Right"
                Margin="0,0,30,30"
                Background="#25262A"
                CornerRadius="12"
                Padding="6"
                Effect="{StaticResource MaterialDesignShadowDepth2}"
                Panel.ZIndex="12">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">

                <!-- 上一页 -->
                <Button x:Name="BtnPrevPage"
                        Click="BtnPrevPage_Click"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="10,8"
                        Visibility="{Binding IsMultiPage, Converter={StaticResource BoolToVis}}">
                    <materialDesign:PackIcon Kind="ChevronLeft" Width="22" Height="22" Foreground="#E0E0E0"/>
                </Button>

                <!-- 页码（点击弹出页面管理） -->
                <Button x:Name="BtnPageIndicator"
                        Click="BtnPageIndicator_Click"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="14,8"
                        Visibility="{Binding IsMultiPage, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="{Binding PageIndicatorText}"
                               Foreground="#2F7DFF"
                               FontWeight="SemiBold"
                               FontSize="14"
                               VerticalAlignment="Center"/>
                </Button>

                <!-- 下一页 -->
                <Button x:Name="BtnNextPage"
                        Click="BtnNextPage_Click"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="10,8"
                        Visibility="{Binding IsMultiPage, Converter={StaticResource BoolToVis}}">
                    <materialDesign:PackIcon Kind="ChevronRight" Width="22" Height="22" Foreground="#E0E0E0"/>
                </Button>

                <!-- 新增页（永远显示） -->
                <Button x:Name="BtnAddPage"
                        Click="BtnAddPage_Click"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="10,8">
                    <materialDesign:PackIcon Kind="Plus" Width="22" Height="22" Foreground="#E0E0E0"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- 页面管理 Popup：点击页码区唤出 -->
        <Popup x:Name="PopupPageManager"
               PlacementTarget="{Binding ElementName=BtnPageIndicator}"
               Placement="Top"
               StaysOpen="False"
               AllowsTransparency="True"
               PopupAnimation="Fade"
               Panel.ZIndex="30">
            <Border Background="#25262A"
                    CornerRadius="16"
                    Padding="14"
                    Width="260"
                    Effect="{StaticResource MaterialDesignShadowDepth2}">
                <StackPanel>

                    <TextBlock Text="页面管理"
                               Foreground="White"
                               FontSize="16"
                               FontWeight="Bold"
                               Margin="2,2,2,12"/>

                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                                  MaxHeight="520">
                        <ItemsControl ItemsSource="{Binding Pages}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border CornerRadius="12"
                                            Margin="0,0,0,12"
                                            BorderThickness="2"
                                            Background="#1E2024">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="BorderBrush" Value="Transparent"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsCurrent}" Value="True">
                                                        <Setter Property="BorderBrush" Value="#2F7DFF"/>
                                                        <Setter Property="Background" Value="#202A3A"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>

                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- 顶部：页号 + 删除 -->
                                            <Grid Margin="10,10,10,8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <Button Grid.Column="0"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        Padding="0"
                                                        HorizontalAlignment="Left"
                                                        Click="PageItem_Click"
                                                        Tag="{Binding}">
                                                    <TextBlock Text="{Binding Number}"
                                                               Foreground="White"
                                                               FontSize="14"
                                                               FontWeight="SemiBold"/>
                                                </Button>

                                                <Button Grid.Column="1"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        Padding="4"
                                                        Click="DeletePage_Click"
                                                        Tag="{Binding}"
                                                        ToolTip="删除此页">
                                                    <materialDesign:PackIcon Kind="TrashCanOutline"
                                                                             Width="18" Height="18"
                                                                             Foreground="#E0E0E0"/>
                                                </Button>
                                            </Grid>

                                            <!-- 缩略图 -->
                                            <Border Grid.Row="1"
                                                    Margin="10,0,10,10"
                                                    CornerRadius="10"
                                                    Background="#0F1216"
                                                    Height="120">
                                                <Image Source="{Binding Preview}"
                                                       Stretch="UniformToFill"
                                                       SnapsToDevicePixels="True"/>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                </StackPanel>
            </Border>
        </Popup>

        <!-- 笔设置弹窗 -->
        <Popup Name="PopupPenSettings" PlacementTarget="{Binding ElementName=RadioPen}"
               Placement="Top" StaysOpen="False" AllowsTransparency="True"
               Panel.ZIndex="20">
            <Border Background="#E625262A" CornerRadius="16" Margin="0,0,0,10"
                    Effect="{StaticResource MaterialDesignShadowDepth2}">
                <StackPanel>
                    <!-- 标题栏 -->
                    <TextBlock Text="画笔设置" FontWeight="Bold" FontSize="16" Foreground="White" Margin="16,12"/>
                    
                    <!-- 分割线 -->
                    <Border Height="1" Background="#505050" Margin="0,0,0,12"/>

                    <!-- 内容区域 -->
                    <Grid Margin="16,0,16,16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- 粗细选择 (左侧) -->
                        <StackPanel Grid.Column="0" Margin="0,0,16,0" VerticalAlignment="Center">
                            <RadioButton GroupName="Thickness" Tag="3" Checked="Thickness_Checked" IsChecked="True" Margin="0,0,0,16"
                                         Style="{StaticResource MaterialDesignToolRadioButton}">
                                <materialDesign:PackIcon Kind="Brush" Width="24" Height="24" Foreground="White"/>
                            </RadioButton>
                            <RadioButton GroupName="Thickness" Tag="6" Checked="Thickness_Checked" Margin="0,0,0,16"
                                         Style="{StaticResource MaterialDesignToolRadioButton}">
                                <materialDesign:PackIcon Kind="Brush" Width="24" Height="24" Foreground="White" RenderTransformOrigin="0.5,0.5">
                                    <materialDesign:PackIcon.RenderTransform>
                                        <ScaleTransform ScaleX="1.2" ScaleY="1.2"/>
                                    </materialDesign:PackIcon.RenderTransform>
                                </materialDesign:PackIcon>
                            </RadioButton>
                            <RadioButton GroupName="Thickness" Tag="9" Checked="Thickness_Checked"
                                         Style="{StaticResource MaterialDesignToolRadioButton}">
                                <materialDesign:PackIcon Kind="Brush" Width="24" Height="24" Foreground="White" RenderTransformOrigin="0.5,0.5">
                                    <materialDesign:PackIcon.RenderTransform>
                                        <ScaleTransform ScaleX="1.5" ScaleY="1.5"/>
                                    </materialDesign:PackIcon.RenderTransform>
                                </materialDesign:PackIcon>
                            </RadioButton>
                        </StackPanel>

                        <!-- 颜色选择 (右侧 3x3 网格) -->
                        <UniformGrid Grid.Column="1" Columns="3" Rows="3" Width="150" Height="150">
                            <Button Background="White" BorderBrush="White" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="White" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="Red" BorderBrush="Red" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="Red" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="#FFD700" BorderBrush="#FFD700" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#FFD700" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>

                            <Button Background="#00C853" BorderBrush="#00C853" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#00C853" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="#00E5FF" BorderBrush="#00E5FF" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#00E5FF" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="#2962FF" BorderBrush="#2962FF" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#2962FF" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>

                            <Button Background="#AA00FF" BorderBrush="#AA00FF" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#AA00FF" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="#C51162" BorderBrush="#C51162" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#C51162" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="Black" BorderBrush="Black" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="Black" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                        </UniformGrid>
                    </Grid>
                </StackPanel>
            </Border>
        </Popup>

    </Grid>
</Window>