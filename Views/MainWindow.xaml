<Window x:Class="WindBoard.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:controls="clr-namespace:WindBoard.Controls"
        Title="{Binding WindowTitle}"
        WindowStyle="None"
        ResizeMode="NoResize"
        WindowState="Maximized"
        Style="{StaticResource MaterialDesignWindow}"
        TextElement.FontFamily="pack://application:,,,/WindBoard;component/resources/fonts/#MiSans"
        Loaded="Window_Loaded">

    <materialDesign:DialogHost Identifier="MainDialogHost" DialogTheme="Inherit">
        <Grid x:Name="RootGrid" Background="#2E2F33" ClipToBounds="False">
        <Grid.Resources>
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>

            <DataTemplate x:Key="AttachmentItemTemplate">
                <Border CornerRadius="10"
                        BorderThickness="1"
                        BorderBrush="#3A3B40"
                        Background="#202126"
                        SnapsToDevicePixels="True">
                    <Grid>
                        <Grid x:Name="DefaultView">
                            <TextBlock Text="{Binding DisplayName}"
                                       Foreground="#EDEDED"
                                       TextWrapping="Wrap"
                                       Margin="12"
                                       FontSize="14"/>
                        </Grid>

                        <Grid x:Name="ImageView" Visibility="Collapsed">
                            <Border Background="#111215" CornerRadius="10"/>
                            <Image Source="{Binding Image}"
                                   Stretch="Uniform"
                                   SnapsToDevicePixels="True"
                                   RenderOptions.BitmapScalingMode="HighQuality"/>
                            <TextBlock x:Name="ImageFallbackText"
                                       Text="{Binding DisplayName}"
                                       Foreground="#BDBDBD"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Margin="12"
                                       FontSize="13"
                                       Visibility="Collapsed"/>
                        </Grid>

                        <Grid x:Name="TextView" Visibility="Collapsed">
                            <ScrollViewer Margin="12"
                                          HorizontalScrollBarVisibility="Disabled"
                                          VerticalScrollBarVisibility="Auto">
                                <TextBlock Text="{Binding Text}"
                                           Foreground="#EDEDED"
                                           TextWrapping="Wrap"
                                           FontSize="14"/>
                            </ScrollViewer>
                        </Grid>

                        <Grid x:Name="VideoView" Visibility="Collapsed" Margin="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <materialDesign:PackIcon Kind="Video"
                                                     Width="28"
                                                     Height="28"
                                                     Foreground="#EDEDED"
                                                     VerticalAlignment="Center"/>
                            <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                <TextBlock Text="{Binding DisplayName}" Foreground="#EDEDED" FontWeight="SemiBold" FontSize="14"/>
                                <TextBlock Text="双击打开外部播放器" Foreground="#BDBDBD" FontSize="12" Margin="0,4,0,0"/>
                            </StackPanel>
                        </Grid>

                        <Grid x:Name="LinkView" Visibility="Collapsed" Margin="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <materialDesign:PackIcon Kind="LinkVariant"
                                                     Width="26"
                                                     Height="26"
                                                     Foreground="#EDEDED"
                                                     VerticalAlignment="Center"/>
                            <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                <TextBlock Text="{Binding Url}" Foreground="#EDEDED" TextWrapping="Wrap" FontSize="13"/>
                                <TextBlock Text="双击外部打开" Foreground="#BDBDBD" FontSize="12" Margin="0,4,0,0"/>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>
                <DataTemplate.Triggers>
                    <DataTrigger Binding="{Binding Type}" Value="Image">
                        <Setter TargetName="DefaultView" Property="Visibility" Value="Collapsed"/>
                        <Setter TargetName="ImageView" Property="Visibility" Value="Visible"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Type}" Value="Text">
                        <Setter TargetName="DefaultView" Property="Visibility" Value="Collapsed"/>
                        <Setter TargetName="TextView" Property="Visibility" Value="Visible"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Type}" Value="Video">
                        <Setter TargetName="DefaultView" Property="Visibility" Value="Collapsed"/>
                        <Setter TargetName="VideoView" Property="Visibility" Value="Visible"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Type}" Value="Link">
                        <Setter TargetName="DefaultView" Property="Visibility" Value="Collapsed"/>
                        <Setter TargetName="LinkView" Property="Visibility" Value="Visible"/>
                    </DataTrigger>

                    <MultiDataTrigger>
                        <MultiDataTrigger.Conditions>
                            <Condition Binding="{Binding Type}" Value="Image"/>
                            <Condition Binding="{Binding Image}" Value="{x:Null}"/>
                        </MultiDataTrigger.Conditions>
                        <Setter TargetName="ImageFallbackText" Property="Visibility" Value="Visible"/>
                    </MultiDataTrigger>
                </DataTemplate.Triggers>
            </DataTemplate>
        </Grid.Resources>

        <!-- 视口：负责“看哪里” -->
        <ScrollViewer x:Name="Viewport"
                      Background="#2E2F33"
                      HorizontalScrollBarVisibility="Hidden"
                      VerticalScrollBarVisibility="Hidden"
                      CanContentScroll="False"
                      PanningMode="None"
                      IsManipulationEnabled="False">

            <!-- 承载层：负责整体缩放（不要缩放 InkCanvas 自己） -->
            <Grid x:Name="CanvasHost" Background="#2E2F33">
                <Grid.LayoutTransform>
                    <ScaleTransform x:Name="ZoomTransform" ScaleX="1" ScaleY="1"/>
                </Grid.LayoutTransform>

                <!-- 导入内容层（底层）：默认在笔迹下方 -->
                <ItemsControl x:Name="AttachmentLayerBottom"
                              ItemsSource="{Binding CurrentAttachments}"
                              ItemTemplate="{StaticResource AttachmentItemTemplate}"
                              IsHitTestVisible="False"
                              Panel.ZIndex="0">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                            <Setter Property="Width" Value="{Binding Width}"/>
                            <Setter Property="Height" Value="{Binding Height}"/>
                            <Setter Property="Panel.ZIndex" Value="{Binding ZIndex}"/>
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsPinnedTop}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                </ItemsControl>

                <!-- 核心白板控件：不再使用 RenderTransform -->
                <InkCanvas Name="MyCanvas"
                           Background="Transparent"
                            Width="8000" Height="8000"
                            HorizontalAlignment="Left" VerticalAlignment="Top"
                            Margin="0"
                            IsManipulationEnabled="False"
                            Panel.ZIndex="10"
                            TouchDown="MyCanvas_TouchDown"
                            TouchMove="MyCanvas_TouchMove"
                            TouchUp="MyCanvas_TouchUp"
                            TouchLeave="MyCanvas_TouchUp"
                            MouseWheel="MyCanvas_MouseWheel">

                    <InkCanvas.DefaultDrawingAttributes>
                        <DrawingAttributes Color="White" Width="1.5" Height="1.5" IgnorePressure="True" FitToCurve="False"/>
                    </InkCanvas.DefaultDrawingAttributes>
                </InkCanvas>

                <!-- 导入内容层（置顶层）：用户显式“置顶”的附件会提升到笔迹之上 -->
                <ItemsControl x:Name="AttachmentLayerTop"
                              ItemsSource="{Binding CurrentAttachments}"
                              ItemTemplate="{StaticResource AttachmentItemTemplate}"
                              IsHitTestVisible="False"
                              Panel.ZIndex="20">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                            <Setter Property="Width" Value="{Binding Width}"/>
                            <Setter Property="Height" Value="{Binding Height}"/>
                            <Setter Property="Panel.ZIndex" Value="{Binding ZIndex}"/>
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsPinnedTop}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                </ItemsControl>

                <!-- 附件交互覆盖层：仅显示选中框/拖拽/缩放句柄（内容仍在 AttachmentLayer，避免遮挡笔迹） -->
                <Canvas x:Name="AttachmentSelectionOverlay"
                        IsHitTestVisible="True"
                        Panel.ZIndex="30"/>

                <!-- 自定义橡皮擦游标覆盖层：跟随内容缩放（不拦截输入） -->
                <Canvas x:Name="EraserOverlay"
                        Width="{Binding ElementName=MyCanvas, Path=Width}"
                        Height="{Binding ElementName=MyCanvas, Path=Height}"
                        IsHitTestVisible="False"
                        Visibility="Collapsed"
                        Panel.ZIndex="41">
                    <Border x:Name="EraserCursorRect"
                            Background="#FFFAFA"
                            CornerRadius="0"
                            Width="40"
                            Height="80"
                            Opacity="1.0"/>
                </Canvas>
            </Grid>
        </ScrollViewer>

        <!-- 选择悬浮 Dock：仅在选中笔迹/附件时显示（覆盖在视口之上，不参与缩放） -->
        <Canvas x:Name="SelectionDockLayer" Panel.ZIndex="25" IsHitTestVisible="True">
            <Border x:Name="SelectionDock"
                    Background="#25262A"
                    CornerRadius="12"
                    Padding="5"
                    Visibility="Collapsed"
                    Effect="{StaticResource MaterialDesignShadowDepth2}">
                <StackPanel Orientation="Horizontal">
                    <Button x:Name="BtnSelectionTop"
                            Content="置顶"
                            Tag="ArrangeBringToFront"
                            Style="{StaticResource BottomButtonStyle}"
                            Click="BtnSelectionTop_Click">
                    </Button>
                    <Button x:Name="BtnSelectionCopy"
                            Content="复制"
                            Tag="ContentCopy"
                            Style="{StaticResource BottomButtonStyle}"
                            Click="BtnSelectionCopy_Click">
                    </Button>
                    <Button x:Name="BtnSelectionDelete"
                            Content="删除"
                            Tag="Delete"
                            Style="{StaticResource BottomButtonStyle}"
                            Click="BtnSelectionDelete_Click">
                    </Button>
                </StackPanel>
            </Border>
        </Canvas>

        <!-- 悬浮工具栏区域（覆盖在视口之上，不参与缩放） -->
        <StackPanel Orientation="Horizontal" VerticalAlignment="Bottom" HorizontalAlignment="Center" Margin="0,0,0,30" Panel.ZIndex="10" Opacity="0.85">
            <!-- 主工具栏 -->
            <Border Background="#25262A" CornerRadius="12" Padding="5"
                    Effect="{StaticResource MaterialDesignShadowDepth2}">
                <StackPanel Orientation="Horizontal">
                    <RadioButton x:Name="RadioSelect" Content="选择" Tag="CursorDefault" GroupName="Tools"
                                 Style="{StaticResource BottomRadioButtonStyle}"
                                 Checked="RadioSelect_Checked"/>

                    <RadioButton x:Name="RadioPen" Content="书写" Tag="Pen" GroupName="Tools" IsChecked="True"
                                 Style="{StaticResource BottomRadioButtonStyle}"
                                 Checked="RadioPen_Checked"
                                 PreviewMouseLeftButtonDown="RadioPen_PreviewMouseLeftButtonDown"
                                 ToolTip="再次单击设置画笔"/>

                    <RadioButton x:Name="RadioEraser" Content="擦除" Tag="Eraser" GroupName="Tools"
                                 Style="{StaticResource BottomRadioButtonStyle}"
                                 Checked="RadioEraser_Checked"
                                 PreviewMouseLeftButtonDown="RadioEraser_PreviewMouseLeftButtonDown"
                                 PreviewTouchDown="RadioEraser_PreviewTouchDown"/>

                    <Rectangle Width="1" Height="24" Fill="#505050" Margin="8,0" VerticalAlignment="Center"/>

                    <Button x:Name="BtnUndo" Content="撤销" Tag="Undo"
                            Style="{StaticResource BottomButtonStyle}"
                            Command="{x:Static ApplicationCommands.Undo}"
                            CommandTarget="{Binding ElementName=MyCanvas}"/>

                    <Button x:Name="BtnRedo" Content="恢复" Tag="Redo"
                            Style="{StaticResource BottomButtonStyle}"
                            Command="{x:Static ApplicationCommands.Redo}"
                            CommandTarget="{Binding ElementName=MyCanvas}"/>
                </StackPanel>
            </Border>

            <!-- 视频展台按钮 Dock（紧贴主dock右侧） -->
            <Border x:Name="VideoDock"
                    Margin="8,0,0,0"
                    Background="#25262A"
                    CornerRadius="12"
                    Padding="5"
                    Effect="{StaticResource MaterialDesignShadowDepth2}"
                    Visibility="{Binding IsVideoPresenterEnabled, Converter={StaticResource BoolToVis}}">
                <StackPanel Orientation="Horizontal">
                    <Button x:Name="BtnVideoPresenter"
                            Content="视频展台"
                            Tag="Video"
                            Style="{StaticResource BottomButtonStyle}"
                            Click="BtnVideoPresenter_Click"/>
                </StackPanel>
            </Border>
        </StackPanel>

        <!-- 右下角：分页控制条抽为控件（覆盖在视口之上，不参与缩放） -->
        <controls:PageNavigatorControl
                VerticalAlignment="Bottom"
                HorizontalAlignment="Right"
                Margin="0,0,30,30"
                Panel.ZIndex="12"
                Pages="{Binding Pages}"
                IsMultiPage="{Binding IsMultiPage}"
                PageIndicatorText="{Binding PageIndicatorText}"
                PrevRequested="BtnPrevPage_Click"
                NextRequested="BtnNextPage_Click"
                AddRequested="BtnAddPage_Click"
                IndicatorClicked="BtnPageIndicator_Click"
                PageSelected="PageNavigator_PageSelected"
                PageDeleteRequested="PageNavigator_PageDeleteRequested" Loaded="PageNavigatorControl_Loaded" Height="70"/>


        <!-- 笔设置弹窗 -->
        <Popup Name="PopupPenSettings" PlacementTarget="{Binding ElementName=RadioPen}"
               Placement="Top" StaysOpen="True" AllowsTransparency="True"
               Panel.ZIndex="20">
            <Border Background="#E625262A" CornerRadius="16" Margin="0,0,0,10"
                    Effect="{StaticResource MaterialDesignShadowDepth2}">
                <StackPanel>
                    <!-- 标题栏 -->
                    <TextBlock Text="画笔设置" FontWeight="Bold" FontSize="16" Foreground="White" Margin="16,12"/>

                    <!-- 分割线 -->
                    <Border Height="1" Background="#505050" Margin="0,0,0,12"/>

                    <!-- 内容区域 -->
                    <Grid Margin="16,0,16,16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- 粗细选择 (左侧) -->
                        <StackPanel Grid.Column="0" Margin="0,0,16,0" VerticalAlignment="Center">
                            <RadioButton GroupName="Thickness" Tag="1.5" Checked="Thickness_Checked" IsChecked="True" Margin="0,0,0,16"
                                         Style="{StaticResource MaterialDesignToolRadioButton}">
                                <materialDesign:PackIcon Kind="Brush" Width="24" Height="24" Foreground="White"/>
                            </RadioButton>
                            <RadioButton GroupName="Thickness" Tag="4.5" Checked="Thickness_Checked" Margin="0,0,0,16"
                                         Style="{StaticResource MaterialDesignToolRadioButton}">
                                <materialDesign:PackIcon Kind="Brush" Width="24" Height="24" Foreground="White" RenderTransformOrigin="0.5,0.5">
                                    <materialDesign:PackIcon.RenderTransform>
                                        <ScaleTransform ScaleX="1.2" ScaleY="1.2"/>
                                    </materialDesign:PackIcon.RenderTransform>
                                </materialDesign:PackIcon>
                            </RadioButton>
                            <RadioButton GroupName="Thickness" Tag="6.5" Checked="Thickness_Checked"
                                         Style="{StaticResource MaterialDesignToolRadioButton}">
                                <materialDesign:PackIcon Kind="Brush" Width="24" Height="24" Foreground="White" RenderTransformOrigin="0.5,0.5">
                                    <materialDesign:PackIcon.RenderTransform>
                                        <ScaleTransform ScaleX="1.5" ScaleY="1.5"/>
                                    </materialDesign:PackIcon.RenderTransform>
                                </materialDesign:PackIcon>
                            </RadioButton>
                        </StackPanel>

                        <!-- 颜色选择 (右侧 3x3 网格) -->
                        <UniformGrid Grid.Column="1" Columns="3" Rows="3" Width="150" Height="150">
                            <Button Background="White" BorderBrush="White" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="White" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="Red" BorderBrush="Red" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="Red" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="#FFD700" BorderBrush="#FFD700" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#FFD700" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>

                            <Button Background="#00C853" BorderBrush="#00C853" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#00C853" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="#00E5FF" BorderBrush="#00E5FF" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#00E5FF" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="#2962FF" BorderBrush="#2962FF" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#2962FF" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>

                            <Button Background="#AA00FF" BorderBrush="#AA00FF" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#AA00FF" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="#C51162" BorderBrush="#C51162" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="#C51162" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                            <Button Background="Black" BorderBrush="Black" Width="36" Height="36" Margin="5" Click="Color_Click" Tag="Black" Style="{StaticResource MaterialDesignFloatingActionMiniButton}"/>
                        </UniformGrid>
                    </Grid>
                </StackPanel>
            </Border>
        </Popup>

        <!-- 擦除清屏滑动弹窗 -->
        <Popup Name="PopupEraserClear"
               PlacementTarget="{Binding ElementName=RadioEraser}"
               Placement="Top"
               StaysOpen="True"
               AllowsTransparency="True"
               Closed="PopupEraserClear_Closed"
               Panel.ZIndex="20">
            <Border Background="#E625262A" CornerRadius="16" Margin="0,0,0,10"
                    Effect="{StaticResource MaterialDesignShadowDepth2}">
                <StackPanel Margin="16,12,16,12">
                    <TextBlock x:Name="TextClearHint" Text="向右滑动清空"
                               FontWeight="Bold"
                               FontSize="16"
                               Foreground="White"
                               Margin="0,0,0,8"
                               HorizontalAlignment="Center"/>
                    <Slider x:Name="SliderClear"
                            Minimum="0"
                            Maximum="100"
                            Width="180"
                            IsManipulationEnabled="False"
                            IsMoveToPointEnabled="False"
                            Tag="0.92"
                            ValueChanged="SliderClear_ValueChanged"
                            PreviewMouseUp="SliderClear_PreviewMouseUp"
                            PreviewTouchUp="SliderClear_PreviewTouchUp"
                            Style="{StaticResource SlideToClearSliderStyle}"/>
                </StackPanel>
            </Border>
        </Popup>

        <!-- 左下角：系统操作 Dock（覆盖在视口之上，不参与缩放） -->
        <Border VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="30,0,0,20"
                Background="#25262A" CornerRadius="12" Padding="5"
                Effect="{StaticResource MaterialDesignShadowDepth2}"
                Panel.ZIndex="12"
                Opacity="0.85">
            <StackPanel Orientation="Horizontal">
                <Button Name="BtnMore" Content="更多" Tag="DotsHorizontal"
                        Style="{StaticResource BottomButtonStyle}"
                        Click="BtnMore_Click"/>
                <Button Name="BtnMinimize" Content="最小化" Tag="WindowMinimize"
                        Style="{StaticResource BottomButtonStyle}"
                        Click="BtnMinimize_Click"/>
                <Button Name="BtnImport" Content="导入" Tag="Download"
                        Style="{StaticResource BottomButtonStyle}"
                        Click="BtnImport_Click"/>
            </StackPanel>
        </Border>

        <!-- 更多 弹出菜单 -->
        <Popup Name="PopupMoreMenu"
               PlacementTarget="{Binding ElementName=BtnMore}"
               Placement="Top"
               StaysOpen="True"
               AllowsTransparency="True"
               Panel.ZIndex="20">
            <Border Background="#E625262A" CornerRadius="16" Margin="0,0,0,10"
                    Effect="{StaticResource MaterialDesignShadowDepth2}">
                <StackPanel Margin="8,8,8,8">
                    <Button Content="设置" Tag="Cog"
                            Style="{StaticResource BottomButtonStyle}"
                            Click="MenuSettings_Click"/>
                    <Button Content="退出" Tag="ExitToApp"
                            Style="{StaticResource BottomButtonStyle}"
                            Click="MenuExit_Click"/>
                </StackPanel>
            </Border>
        </Popup>

    </Grid>
    </materialDesign:DialogHost>
</Window>
